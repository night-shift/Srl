#include "Tests.h"
#include "BasicStruct.h"
#include "Srl/Hash.h"
#include "Srl/PJson.h"
#include "Srl/PMsgPack.h"
#include "Srl/PSrl.h"
#include "Srl/String.h"
#include "Srl/Tools.h"
#include "Srl/Tree.h"

#include <sstream>

using namespace std;
using namespace Tests;
using namespace Srl;

bool Tests::Verbose                = false;
bool Tests::Run_Benchmarks         = false;
size_t Tests::Benchmark_Objects    = 10000;
size_t Tests::Benchmark_Iterations = 1;


void Tests::print_source(const vector<uint8_t>& source)
{
    for(auto c : source) {
        cout << (const char)c;
    }
    cout << endl;
}

void Tests::print_log(const std::string& message)
{
    if(Tests::Verbose) {
        cout << message;
    }
}

void test_msgpack()
{
    string input_hex = "8fab31302e6e696c2e79616d6c9182a36e696cc0a76d73677061636b91a26330ac31312e626f6f6c2e79616d6c9282a4626f6f6cc2a76d73677061636b91a2633282a4626f6f6cc3a76d73677061636b91a26333ae31322e62696e6172792e79616d6c9382a662696e617279a0a76d73677061636b93a563342d3030a863352d30302d3030ae63362d30302d30302d30302d303082a662696e617279a23031a76d73677061636b93a863342d30312d3031ab63352d30302d30312d3031b163362d30302d30302d30302d30312d303182a662696e617279a530302d6666a76d73677061636b93ab63342d30322d30302d6666ae63352d30302d30322d30302d6666b463362d30302d30302d30302d30322d30302d6666b732302e6e756d6265722d706f7369746976652e79616d6c9b82a66e756d62657200a76d73677061636b9ba23030a563632d3030a863642d30302d3030ae63652d30302d30302d30302d3030ba63662d30302d30302d30302d30302d30302d30302d30302d3030a564302d3030a864312d30302d3030ae64322d30302d30302d30302d3030ba64332d30302d30302d30302d30302d30302d30302d30302d3030ae63612d30302d30302d30302d3030ba63622d30302d30302d30302d30302d30302d30302d30302d303082a66e756d62657201a76d73677061636b9ba23031a563632d3031a863642d30302d3031ae63652d30302d30302d30302d3031ba63662d30302d30302d30302d30302d30302d30302d30302d3031a564302d3031a864312d30302d3031ae64322d30302d30302d30302d3031ba64332d30302d30302d30302d30302d30302d30302d30302d3031ae63612d33662d38302d30302d3030ba63622d33662d66302d30302d30302d30302d30302d30302d303082a66e756d6265727fa76d73677061636b99a23766a563632d3766a863642d30302d3766ae63652d30302d30302d30302d3766ba63662d30302d30302d30302d30302d30302d30302d30302d3766a564302d3766a864312d30302d3766ae64322d30302d30302d30302d3766ba64332d30302d30302d30302d30302d30302d30302d30302d376682a66e756d626572cc80a76d73677061636b97a563632d3830a863642d30302d3830ae63652d30302d30302d30302d3830ba63662d30302d30302d30302d30302d30302d30302d30302d3830a864312d30302d3830ae64322d30302d30302d30302d3830ba64332d30302d30302d30302d30302d30302d30302d30302d383082a66e756d626572ccffa76d73677061636b97a563632d6666a863642d30302d6666ae63652d30302d30302d30302d6666ba63662d30302d30302d30302d30302d30302d30302d30302d6666a864312d30302d6666ae64322d30302d30302d30302d6666ba64332d30302d30302d30302d30302d30302d30302d30302d666682a66e756d626572cd0100a76d73677061636b96a863642d30312d3030ae63652d30302d30302d30312d3030ba63662d30302d30302d30302d30302d30302d30302d30312d3030a864312d30312d3030ae64322d30302d30302d30312d3030ba64332d30302d30302d30302d30302d30302d30302d30312d303082a66e756d626572cdffffa76d73677061636b95a863642d66662d6666ae63652d30302d30302d66662d6666ba63662d30302d30302d30302d30302d30302d30302d66662d6666ae64322d30302d30302d66662d6666ba64332d30302d30302d30302d30302d30302d30302d66662d666682a66e756d626572ce00010000a76d73677061636b94ae63652d30302d30312d30302d3030ba63662d30302d30302d30302d30302d30302d30312d30302d3030ae64322d30302d30312d30302d3030ba64332d30302d30302d30302d30302d30302d30312d30302d303082a66e756d626572ce7fffffffa76d73677061636b94ae63652d37662d66662d66662d6666ba63662d30302d30302d30302d30302d37662d66662d66662d6666ae64322d37662d66662d66662d6666ba64332d30302d30302d30302d30302d37662d66662d66662d666682a66e756d626572ce80000000a76d73677061636b95ae63652d38302d30302d30302d3030ba63662d30302d30302d30302d30302d38302d30302d30302d3030ba64332d30302d30302d30302d30302d38302d30302d30302d3030ae63612d34662d30302d30302d3030ba63622d34312d65302d30302d30302d30302d30302d30302d303082a66e756d626572ceffffffffa76d73677061636b94ae63652d66662d66662d66662d6666ba63662d30302d30302d30302d30302d66662d66662d66662d6666ba64332d30302d30302d30302d30302d66662d66662d66662d6666ba63622d34312d65662d66662d66662d66662d65302d30302d3030b732312e6e756d6265722d6e656761746976652e79616d6c9882a66e756d626572ffa76d73677061636b97a26666a564302d6666a864312d66662d6666ae64322d66662d66662d66662d6666ba64332d66662d66662d66662d66662d66662d66662d66662d6666ae63612d62662d38302d30302d3030ba63622d62662d66302d30302d30302d30302d30302d30302d303082a66e756d626572e0a76d73677061636b97a26530a564302d6530a864312d66662d6530ae64322d66662d66662d66662d6530ba64332d66662d66662d66662d66662d66662d66662d66662d6530ae63612d63322d30302d30302d3030ba63622d63302d34302d30302d30302d30302d30302d30302d303082a66e756d626572d0dfa76d73677061636b94a564302d6466a864312d66662d6466ae64322d66662d66662d66662d6466ba64332d66662d66662d66662d66662d66662d66662d66662d646682a66e756d626572d1ff80a76d73677061636b94a564302d3830a864312d66662d3830ae64322d66662d66662d66662d3830ba64332d66662d66662d66662d66662d66662d66662d66662d383082a66e756d626572d1ff00a76d73677061636b93a864312d66662d3030ae64322d66662d66662d66662d3030ba64332d66662d66662d66662d66662d66662d66662d66662d303082a66e756d626572d2ffff8000a76d73677061636b93a864312d38302d3030ae64322d66662d66662d38302d3030ba64332d66662d66662d66662d66662d66662d66662d38302d303082a66e756d626572d2ffff0000a76d73677061636b92ae64322d66662d66662d30302d3030ba64332d66662d66662d66662d66662d66662d66662d30302d303082a66e756d626572d3ffffffff80000000a76d73677061636b93ae64322d38302d30302d30302d3030ba64332d66662d66662d66662d66662d38302d30302d30302d3030ba63622d63312d65302d30302d30302d30302d30302d30302d3030b432322e6e756d6265722d666c6f61742e79616d6c9282a66e756d626572cb3fe0000000000000a76d73677061636b92ae63612d33662d30302d30302d3030ba63622d33662d65302d30302d30302d30302d30302d30302d303082a66e756d626572cbbfe0000000000000a76d73677061636b92ae63612d62662d30302d30302d3030ba63622d62662d65302d30302d30302d30302d30302d30302d3030b532332e6e756d6265722d6269676e756d2e79616d6c9983a66e756d626572cf0000000100000000a66269676e756daa34323934393637323936a76d73677061636b94ba63662d30302d30302d30302d30312d30302d30302d30302d3030ba64332d30302d30302d30302d30312d30302d30302d30302d3030ae63612d34662d38302d30302d3030ba63622d34312d66302d30302d30302d30302d30302d30302d303083a66e756d626572d3ffffffff00000000a66269676e756dab2d34323934393637323936a76d73677061636b92ba64332d66662d66662d66662d66662d30302d30302d30302d3030ba63622d63312d66302d30302d30302d30302d30302d30302d303083a66e756d626572cf0001000000000000a66269676e756daf323831343734393736373130363536a76d73677061636b94ba63662d30302d30312d30302d30302d30302d30302d30302d3030ba64332d30302d30312d30302d30302d30302d30302d30302d3030ae63612d35372d38302d30302d3030ba63622d34322d66302d30302d30302d30302d30302d30302d303083a66e756d626572d3ffff000000000000a66269676e756db02d323831343734393736373130363536a76d73677061636b93ba64332d66662d66662d30302d30302d30302d30302d30302d3030ae63612d64372d38302d30302d3030ba63622d63322d66302d30302d30302d30302d30302d30302d303082a66269676e756db339323233333732303336383534373735383037a76d73677061636b92ba64332d37662d66662d66662d66662d66662d66662d66662d6666ba63662d37662d66662d66662d66662d66662d66662d66662d666682a66269676e756db42d39323233333732303336383534373735383037a76d73677061636b91ba64332d38302d30302d30302d30302d30302d30302d30302d303182a66269676e756db339323233333732303336383534373735383038a76d73677061636b91ba63662d38302d30302d30302d30302d30302d30302d30302d303082a66269676e756db42d39323233333732303336383534373735383038a76d73677061636b91ba64332d38302d30302d30302d30302d30302d30302d30302d303082a66269676e756db43138343436373434303733373039353531363135a76d73677061636b91ba63662d66662d66662d66662d66662d66662d66662d66662d6666b433302e737472696e672d61736369692e79616d6c9482a6737472696e67a0a76d73677061636b94a26130a564392d3030a864612d30302d3030ae64622d30302d30302d30302d303082a6737472696e67a161a76d73677061636b94a561312d3631a864392d30312d3631ab64612d30302d30312d3631b164622d30302d30302d30302d30312d363182a6737472696e67bf31323334353637383930313233343536373839303132333435363738393031a76d73677061636b93d95f62662d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d3331d96264392d31662d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d3331d96564612d30302d31662d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d333182a6737472696e67d9203132333435363738393031323334353637383930313233343536373839303132a76d73677061636b92d96564392d32302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d3332d96864612d30302d32302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d33322d33332d33342d33352d33362d33372d33382d33392d33302d33312d3332b333312e737472696e672d757466382e79616d6c9582a6737472696e67b2d09ad0b8d180d0b8d0bbd0bbd0b8d186d0b0a76d73677061636b92d93862322d64302d39612d64302d62382d64312d38302d64302d62382d64302d62622d64302d62622d64302d62382d64312d38362d64302d6230d93b64392d31322d64302d39612d64302d62382d64312d38302d64302d62382d64302d62622d64302d62622d64302d62382d64312d38362d64302d623082a6737472696e67ace381b2e38289e3818ce381aaa76d73677061636b92d92661632d65332d38312d62322d65332d38322d38392d65332d38312d38632d65332d38312d6161d92964392d30632d65332d38312d62322d65332d38322d38392d65332d38312d38632d65332d38312d616182a6737472696e67a6ed959ceab880a76d73677061636b92b461362d65642d39352d39632d65612d62382d3830b764392d30362d65642d39352d39632d65612d62382d383082a6737472696e67a6e6b189e5ad97a76d73677061636b92b461362d65362d62312d38392d65352d61642d3937b764392d30362d65362d62312d38392d65352d61642d393782a6737472696e67a6e6bca2e5ad97a76d73677061636b92b461362d65362d62632d61322d65352d61642d3937b764392d30362d65362d62632d61322d65352d61642d3937b433322e737472696e672d656d6f6a692e79616d6c9282a6737472696e67a3e29da4a76d73677061636b92ab61332d65322d39642d6134ae64392d30332d65322d39642d613482a6737472696e67a6eda0bcedbdbaa76d73677061636b92ae61342d66302d39662d38642d6261b164392d30342d66302d39662d38642d6261ad34302e61727261792e79616d6c9582a5617272617990a76d73677061636b93a23930a864632d30302d3030ae64642d30302d30302d30302d303082a561727261799101a76d73677061636b93a539312d3031ab64632d30302d30312d3031b164642d30302d30302d30302d30312d303182a561727261799f0102030405060708090a0b0c0d0e0fa76d73677061636b93d92f39662d30312d30322d30332d30342d30352d30362d30372d30382d30392d30612d30622d30632d30642d30652d3066d93564632d30302d30662d30312d30322d30332d30342d30352d30362d30372d30382d30392d30612d30622d30632d30642d30652d3066d93b64642d30302d30302d30302d30662d30312d30322d30332d30342d30352d30362d30372d30382d30392d30612d30622d30632d30642d30652d306682a56172726179dc00100102030405060708090a0b0c0d0e0f10a76d73677061636b92d93864632d30302d31302d30312d30322d30332d30342d30352d30362d30372d30382d30392d30612d30622d30632d30642d30652d30662d3130d93e64642d30302d30302d30302d31302d30312d30322d30332d30342d30352d30362d30372d30382d30392d30612d30622d30632d30642d30652d30662d313082a5617272617991a161a76d73677061636b93a839312d61312d3631ae64632d30302d30312d61312d3631b464642d30302d30302d30302d30312d61312d3631ab34312e6d61702e79616d6c9382a36d617080a76d73677061636b93a23830a864652d30302d3030ae64662d30302d30302d30302d303082a36d617081a16101a76d73677061636b93ab38312d61312d36312d3031b164652d30302d30312d61312d36312d3031b764662d30302d30302d30302d30312d61312d36312d303182a36d617081a161a141a76d73677061636b93ae38312d61312d36312d61312d3431b464652d30302d30312d61312d36312d61312d3431ba64662d30302d30302d30302d30312d61312d36312d61312d3431ae34322e6e65737465642e79616d6c9482a561727261799190a76d73677061636b93a539312d3930b164632d30302d30312d64632d30302d3030bd64642d30302d30302d30302d30312d64642d30302d30302d30302d303082a561727261799180a76d73677061636b93a539312d3830ab64632d30302d30312d3830b164642d30302d30302d30302d30312d383082a36d617081a16180a76d73677061636b93ab38312d61312d36312d3830b764652d30302d30312d61312d36312d64652d30302d3030d92364662d30302d30302d30302d30312d61312d36312d64662d30302d30302d30302d303082a36d617081a16190a76d73677061636b93ab38312d61312d36312d3930b164652d30302d30312d61312d36312d3930b764662d30302d30302d30302d30312d61312d36312d3930b135302e74696d657374616d702e79616d6cdc001382a974696d657374616d7092ce5a4af6a500a76d73677061636b91b164362d66662d35612d34612d66362d613582a974696d657374616d7092ce5a4af6a5ce287735f2a76d73677061636b91bd64372d66662d61312d64632d64372d63382d35612d34612d66362d613582a974696d657374616d7092ce7fffffffce3b9ac9ffa76d73677061636b91bd64372d66662d65652d36622d32372d66632d37662d66662d66662d666682a974696d657374616d7092ce8000000000a76d73677061636b91b164362d66662d38302d30302d30302d303082a974696d657374616d7092ce8000000001a76d73677061636b91bd64372d66662d30302d30302d30302d30342d38302d30302d30302d303082a974696d657374616d7092ceffffffff00a76d73677061636b91b164362d66662d66662d66662d66662d666682a974696d657374616d7092ceffffffffce3b9ac9ffa76d73677061636b91bd64372d66662d65652d36622d32372d66632d66662d66662d66662d666682a974696d657374616d7092cf000000010000000000a76d73677061636b91bd64372d66662d30302d30302d30302d30312d30302d30302d30302d303082a974696d657374616d7092cf00000003ffffffffce3b9ac9ffa76d73677061636b91bd64372d66662d65652d36622d32372d66662d66662d66662d66662d666682a974696d657374616d7092cf000000040000000000a76d73677061636b91d92c63372d30632d66662d30302d30302d30302d30302d30302d30302d30302d30342d30302d30302d30302d303082a974696d657374616d7092ff00a76d73677061636b91d92c63372d30632d66662d30302d30302d30302d30302d66662d66662d66662d66662d66662d66662d66662d666682a974696d657374616d7092ffce3b9ac9ffa76d73677061636b91d92c63372d30632d66662d33622d39612d63392d66662d66662d66662d66662d66662d66662d66662d66662d666682a974696d657374616d70920000a76d73677061636b91b164362d66662d30302d30302d30302d303082a974696d657374616d70920001a76d73677061636b91bd64372d66662d30302d30302d30302d30342d30302d30302d30302d303082a974696d657374616d70920100a76d73677061636b91b164362d66662d30302d30302d30302d303182a974696d657374616d7092d3ffffffff7c55817fce3b9ac9ffa76d73677061636b91d92c63372d30632d66662d33622d39612d63392d66662d66662d66662d66662d66662d37632d35352d38312d376682a974696d657374616d7092d3ffffffff7c55818000a76d73677061636b91d92c63372d30632d66662d30302d30302d30302d30302d66662d66662d66662d66662d37632d35352d38312d383082a974696d657374616d7092d3fffffff1868b840000a76d73677061636b91d92c63372d30632d66662d30302d30302d30302d30302d66662d66662d66662d66312d38362d38622d38342d303082a974696d657374616d7092cf0000003afff4417fce3b9ac9ffa76d73677061636b91d92c63372d30632d66662d33622d39612d63392d66662d30302d30302d30302d33612d66662d66342d34312d3766ab36302e6578742e79616d6c9782a36578749201a23130a76d73677061636b91a864342d30312d313082a36578749202a532302d3231a76d73677061636b91ab64352d30322d32302d323182a36578749203ab33302d33312d33322d3333a76d73677061636b91b164362d30332d33302d33312d33322d333382a36578749204b734302d34312d34322d34332d34342d34352d34362d3437a76d73677061636b91bd64372d30342d34302d34312d34322d34332d34342d34352d34362d343782a36578749205d92f35302d35312d35322d35332d35342d35352d35362d35372d35382d35392d35612d35622d35632d35642d35652d3566a76d73677061636b91d93564382d30352d35302d35312d35322d35332d35342d35352d35362d35372d35382d35392d35612d35622d35632d35642d35652d356682a36578749206a0a76d73677061636b93a863372d30302d3036ab63382d30302d30302d3036b163392d30302d30302d30302d30302d303682a36578749207a837302d37312d3732a76d73677061636b93b163372d30332d30372d37302d37312d3732b463382d30302d30332d30372d37302d37312d3732ba63392d30302d30302d30302d30332d30372d37302d37312d3732";
    //"88a7636f6d70616374c3a6736368656d6100a7626f6f6c65616ec3a9736d616c6c5f696e7403ad736d616c6c5f6e65675f696e74fda76269675f696e74ce00bc614eab6269675f696e745f6e6567d2ff439eb2a5666c6f6174cb3fd3333333333333";

    auto input_bytes = Srl::Tools::hex_to_bytes((const uint8_t*)input_hex.data(), input_hex.length());

    printf("hex sz %lu\n", input_hex.length());
    for(auto b : input_bytes) {
       // printf("%02X ", (int)b);
    }

    printf("\n");

    Srl::Tree tree;

    tree.load_source(input_bytes, Srl::PMsgPack());
    tree.to_source(cout, Srl::PJson(false));

}


int main(int argc, char** args)
{
   // test_msgpack();
   // return 0;

    for(int i = 0; i < argc; i++) {
        if(string(args[i]) == "-v") {
            Tests::Verbose = true;

        } else if(string(args[i]) == "-b") {
            Tests::Run_Benchmarks = true;

        } else if(string(args[i], 3) == "-o=") {
            istringstream is(string(args[i] + 3));
            int in;
            is >> in;
            if(in >= 0) { Tests::Benchmark_Objects = in; }

        } else if(string(args[i], 3) == "-i=") {
            istringstream is(string(args[i] + 3));
            int in;
            is >> in;
            if(in >= 0) { Tests::Benchmark_Iterations = in; }
        }
    }

    if(Tests::Run_Benchmarks) {
        Tests::run_benches();

    } else {
        bool success = Tests::test_parser();
        success &= Tests::test_malicious_input();
        success &= Tests::test_misc();

        cout<<endl;
        if(success) {
            cout << "Tests passed." <<endl;
        } else {
            cout << "Tests failed." <<endl;
        }
    }

    return 0;
}
